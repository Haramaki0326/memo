# DB における文字コード・照合順序

## 参考

- [日本語版の SQL Server の文字コードの基本](https://blog.engineer-memo.com/2021/06/21/%E6%97%A5%E6%9C%AC%E8%AA%9E%E7%89%88%E3%81%AE-sql-server-%E3%81%AE%E6%96%87%E5%AD%97%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E5%9F%BA%E6%9C%AC/)
- [SQL Server の UTF-8 サポートのデータストアへの格納と取得について](https://blog.engineer-memo.com/2021/12/31/sql-server-%E3%81%AE-utf-8-%E3%82%B5%E3%83%9D%E3%83%BC%E3%83%88%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%B9%E3%83%88%E3%82%A2%E3%81%B8%E3%81%AE%E6%A0%BC%E7%B4%8D%E3%81%A8%E5%8F%96%E5%BE%97%E3%81%AB/)

## Unicode と SJIS の関係

- SQL Server では次のデータ型が Unicode データをサポートします。

  - `nchar`
  - `nvarchar`
  - `ntext`
    次の点を除き、`nchar`、`nvarchar`、`ntext` は、それぞれ char、varchar、text と同じです。

- **Unicode の方が広範な文字をサポートします。**
  - 環境依存文字
  - サロゲートペア文字

| 文字                                                                                      | カテゴリー         |
| ----------------------------------------------------------------------------------------- | ------------------ |
| 髙（はしご高）                                                                            | IBM 拡張漢字       |
| ①（丸数字）<br>Ⅳ（ローマ数宇）                                                            | NEC 特殊文字       |
| 🍣🍺（寿司ビール）                                                                        | 絵文字             |
| 俱（１面１４区）<br>顗（１面９４区）                                                      | JIS 第 3 水準漢字  |
| 么（２面１区）<br>鳦（２面９４区）                                                        | JIS 第４水準漢字   |
| ![](https://4engineer.net/wp-content/uploads/2022/05/surrogate_pair_jou.png)（D840 DC0B） | サロゲートペア文字 |

- Unicode 文字の方が格納に多くの記憶域を必要とします。
- char 型列と `varchar` 型列の最大サイズは 8,000 文字であるのに対し、`nchar` 型列の- 最大サイズは 4,000 文字です。
- `nvarchar` 型列の最大サイズは、2^31 バイトで、max 指定子を使用して指定します。- `nvarchar`(max) の詳細については、「大きな値のデータ型の使用」を参照してくださ- い。
- Unicode 定数は先頭に N を付けて指定します。つまり、「N'Unicode 文字列'」と指定します。
- Unicode データは Unicode 標準により規定された文字セットを使用します。Unicode 列に使われる Unicode 照合順序は、大文字と小文字の区別、アクセントの区別、かなの区別、文字幅の区別、バイナリなどの属性を基に指定されます。

## 文字コード

| 型       | 文字コード | 文字数 | バイト数                       | 備考                                        |
| -------- | ---------- | ------ | ------------------------------ | ------------------------------------------- |
| char     | ShiftJIS   | 固定   | 半角 1 バイト<br>全角 2 バイト | 全角非推奨                                  |
| varchar  | ShiftJIS   | 可変   | 半角 1 バイト<br>全角 2 バイト | 全角非推奨<br>最大文字数指定（未満でも OK） |
| nchar    | Unicode    | 固定   | 半角全角ともに 1 文字 2 バイト |                                             |
| nvarchar | Unicode    | 可変   | 半角全角ともに 1 文字 2 バイト | 最大文字数指定（未満でも OK）               |

### 文字コードの設定箇所

SQLServer には文字列の区別、ソート順を決定する照合順序という定義がありますが、文字コードはそれと同一箇所で設定します。
設定する箇所は以下となります。

- サーバに設定（SQLServer インストール時に指定）
- データベースに設定（CREATE DATABASE 句で指定）
- テーブルに設定（CREATE TABLE 句で指定）
- 列に設定（CREATE TABLE 句で指定

### 優先順位

`列に定義＞テーブルに定義＞データベースに定義＞サーバに定義`

となります。

列に定義がなければテーブル定義を、テーブルに定義がなければデータベースの定義を、データベースに定義がなければサーバの定義が使用されることになります。

### 確認方法

確認方法は以下となります。

- 確認したい列は `UNICODE` 型か非 `UNICODE` 型かをまず確認する
  - `UNICODE` 型
    - 頭に`n`が付く`char`型（`nchar`、`nvarchar`、`ntext`）
  - 非 `UNICODE` 型
    - 頭に`n`が付かない`char`型（`char`、`varchar`、`text`）

#### `UNICODE` 型の場合

文字コード（コードページ）は `UTF-16` 確定。

#### 非 `UNICODE` 型の場合

照合順序の確認へ

##### 照合順序の確認

非 `UNICODE` 型の列の照合順序を確認します。

```sql
SELECT name, collation_name FROM sys.columns WHERE name = N'確認したい列名';
----------------------------------------
確認したい列名 Japanese_CI_AS
```

この列の照合順序は
Japanese_CI_AS
と出ました。

今回確認したいのは文字コード（＝コードページ）ですので、この照合順序が Shift-JIS 形式なのか UTF-8 形式なのか以下のクエリで調べます。

```sql
SELECT COLLATIONPROPERTY('Japanese_CI_AS', 'CodePage')
----------------------------------------
932
```

932
と出ました。

コードページ 932 とはいわゆる Shift-JIS です。
[Code Page Identifiers](https://learn.microsoft.com/ja-jp/windows/win32/intl/code-page-identifiers)

| 識別子 | .NET 名   | 関連情報                                                                                                   |
| ------ | --------- | ---------------------------------------------------------------------------------------------------------- |
| 932    | shift_jis | ANSI/OEM 日本語;日本語 (Shift-JIS)                                                                         |
| 1200   | utf-16    | Unicode UTF-16、リトル エンディアン バイト順 (ISO 10646 の BMP)マネージド アプリケーションでのみ使用できる |
| 65000  | utf-7     | Unicode (UTF-7)                                                                                            |
| 65001  | utf-8     | Unicode (UTF-8)                                                                                            |

### 結論

今回確認した環境の文字コードは

```
■ 非 UNICODE 型の列
→Shift-JIS

■UNICODE 型の列
→UTF-16
```

であることが確認できました。

### 補足

Shift-JIS で定義された列に UTF-8 のコードの文字を挿入すると、Shift-JIS に存在する文字コードの場合は指定した文字とは異なる文字として認識／格納され、Shift-JIS に存在しない文字コードの文字を挿入すると、???となって格納されてしまいます。

これは接続ドライバによっては変換を行ってくれるものもありますが、負荷を軽減する意味でもアプリケーションが指定する文字コード（セット）と DB 側の文字コード（セット）は統一した方がよいかと思います。

## 照合順序

### 概要

- データの並べ替えや比較を行うための規則のことを照合順序と言います。
- 全角半角を区別したり、逆に区別しないようにする設定ができます。
- それによりデータの並び順が変わったり、クエリの検索結果が変わったりします。

### 種類

|                  | 区別しない | 区別する | 例         |
| ---------------- | ---------- | -------- | ---------- |
| 大文字小文字     | Ci         | CS       | `A`と`a`   |
| アクセント       | AI         | AS       | `a`と`ấ`   |
| ひらがなカタカナ | 省略する   | KS       | `あ`と`ア` |
| 全角と半角       | 省略する   | WS       | `Ａ`と`A`  |

### 例

`Japanese_XJIS_100_CI_AI_KS_WS`という照合順序が設定されていたとします。
このとき

- 日本語辞書を使って照合します
- 大文字小文字は区別しません
- アクセントは区別しません
- ひらがなカタカナは区別します
- 全角半角は区別します
  という意味になります。

## N プレフィックス

- SQL Server に Shift_JIS では表現できない文字（Unicode 文字）を格納すると`???`で文字化けすることがあります。
- これは、Unicode 文字がデータベース既定のコードページに自動的に変換された結果起こります。

```sql
--鴎の字はしなかもめ
INSERT INTO TABLE ("ID", "NAME") VALUES ('1', '森鴎外');
```

このため、文字化けせずに正しく Unicode の文字列を格納するには、以下の方法を用います。

**Unicode 文字列の前に N プレフィックスを付ける**

```sql
INSERT INTO TABLE ("ID", "NAME") VALUES ('1', N'森鴎外');
```
